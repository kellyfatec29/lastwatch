<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LastWatch</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* BASE STYLES */
        body { background: #0a0f1a; color: white; min-height: 100vh; font-family: 'Inter', sans-serif; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .auth-box { background: rgba(17, 24, 39, 0.95); border-radius: 20px; padding: 40px; max-width: 450px; width: 100%; }
        .logo h1 { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #7c3aed, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .form-control { background: #1f2937; border: 2px solid #374151; color: white; margin-bottom: 15px; border-radius: 10px; }
        .form-control:focus { background: #1f2937; border-color: #7c3aed; color: white; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.5); }
        .btn-primary { background: linear-gradient(135deg, #7c3aed, #ec4899); border: none; width: 100%; padding: 14px; border-radius: 10px; transition: all 0.2s; }
        .app-container { display: none; }
        .navbar { background: rgba(17, 24, 39, 0.95); padding: 15px 0; border-bottom: 1px solid #1f2937; }
        .nav-brand { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, #7c3aed, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-btn { background: #1f2937; border: none; color: white; padding: 10px 20px; border-radius: 8px; margin: 0 5px; cursor: pointer; transition: all 0.2s; }
        .nav-btn.active { background: linear-gradient(135deg, #7c3aed, #ec4899); box-shadow: 0 4px 10px rgba(124, 58, 237, 0.3); }

        /* SEARCH GRID */
        .search-container { padding: 30px 0; }
        .search-input { border-radius: 16px; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .media-card { background: #1f2937; border-radius: 16px; overflow: hidden; transition: all 0.3s ease; cursor: pointer; border: 2px solid transparent; position: relative; }
        .media-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(124, 58, 237, 0.3); border-color: #7c3aed; }
        /* CORREÇÃO CSS: Unificando a altura das imagens do card principal */
        .media-card img { width: 100%; height: 270px; object-fit: cover; transition: transform 0.3s; }
        .media-card:hover img { transform: scale(1.05); }

        /* MODAL DETAILS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s ease-out; }
        .modal-content { background: linear-gradient(180deg, #1a1f2e 0%, #0a0f1a 100%); border-radius: 20px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.4s ease-out; }
        
        .modal-top-section { display: flex; gap: 25px; margin-bottom: 30px; align-items: flex-start; }
        .modal-top-poster { flex-shrink: 0; width: 150px; height: 225px; border-radius: 12px; object-fit: cover; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); }
        .modal-synopsis-box { background: rgba(31, 41, 55, 0.5); padding: 20px; border-radius: 12px; border-left: 4px solid #ec4899; }
        .modal-synopsis-box h4 { font-size: 1.1rem; font-weight: 700; color: #ec4899; margin-bottom: 10px; }
        .btn-add-modal { width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 1.1rem; transition: all 0.3s; }
        
        .section-title { font-size: 1.3rem; font-weight: 700; margin: 30px 0 15px 0; color: #7c3aed; display: flex; align-items: center; gap: 10px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
        .info-item { background: rgba(31, 41, 55, 0.5); padding: 15px; border-radius: 10px; }

        /* FRANCHISE SECTION STYLES */
        .franchise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .btn-franchise-details {
            background: #ec4899;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-franchise-details:hover {
            background: #d94676;
        }
        .similar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .similar-item img {
            width: 100%;
            height: 180px; /* Pequena imagem para a seção "Similar" */
            object-fit: cover;
        }

        /* NEW FRANCHISE VIEW STYLES - REFORÇO DA CONSISTÊNCIA */
        #franchiseView {
            padding: 30px 0;
        }
        .franchise-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            background: #1f2937;
            border-radius: 12px;
        }
        .franchise-controls select {
            background: #0a0f1a;
            color: white;
            border: 1px solid #374151;
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 200px;
        }
        .franchise-controls button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .franchise-controls button:hover {
            background: #b91c1c;
        }
        .franchise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        .franchise-card {
            background: #1f2937;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .franchise-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
            border-color: #ec4899;
        }
        /* CORREÇÃO CSS: Garante que as imagens do card de franquia tenham o mesmo tamanho que os cards de busca (270px) */
        .franchise-card img {
            width: 100%;
            height: 270px; 
            object-fit: cover;
        }
        .franchise-card-info {
            padding: 15px;
            text-align: center;
        }
        .franchise-card-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .franchise-card-meta {
            font-size: 0.85rem;
            color: #9ca3af;
        }
        .franchise-loading {
             text-align: center; padding: 60px 0;
        }

        /* MEDIA QUERIES */
        @media (max-width: 768px) {
            .modal-top-section { flex-direction: column; align-items: center; text-align: center; }
            .modal-top-poster { width: 180px; height: 270px; }
            .modal-top-info { margin-left: 0; }
            .modal-top-title { font-size: 1.5rem; }
            .info-grid { grid-template-columns: 1fr; }
            .modal-meta { justify-content: center; }
            .franchise-controls { flex-direction: column; align-items: stretch; }
            .franchise-controls select { width: 100%; }
            /* Garante que o grid de similares/franquias menores se ajustem no mobile */
            .similar-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <div class="logo text-center mb-4">
                <h1>LastWatch</h1>
                <p>Nunca mais perca o episódio</p>
            </div>
            <div id="authError" class="alert alert-danger hidden"></div>
            <div id="loginForm">
                <input type="email" id="loginEmail" class="form-control" placeholder="Email">
                <input type="password" id="loginPassword" class="form-control" placeholder="Senha">
                <button class="btn btn-primary" id="btnLogin">Entrar</button>
            </div>
            <div id="signupForm" class="hidden">
                <input type="email" id="signupEmail" class="form-control" placeholder="Email">
                <input type="password" id="signupPassword" class="form-control" placeholder="Senha (min 6)">
                <button class="btn btn-primary" id="btnSignup">Criar Conta</button>
            </div>
            <button class="btn btn-secondary mt-3 w-100" id="btnToggleAuth">Criar nova conta</button>
        </div>
    </div>

    <div id="appContainer" class="app-container">
        <nav class="navbar">
            <div class="container">
                <span class="nav-brand">LastWatch</span>
                <div>
                    <button class="nav-btn active" id="btnMyList">Minha Lista</button>
                    <button class="nav-btn" id="btnSearch">Pesquisar</button>
                    <button class="nav-btn" id="btnLogout" style="background:#dc2626">Sair</button>
                </div>
            </div>
        </nav>
        <div class="container mt-4">
            <div id="appError" class="alert alert-danger hidden"></div>
            <!-- VISUALIZAÇÃO DE PESQUISA -->
            <div id="searchView" class="hidden">
                <div class="search-container">
                    <div class="search-box">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="search-input" 
                            placeholder="Digite o nome do filme ou série..."
                            autocomplete="off"
                        >
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="search-info" id="searchInfo">
                        <i class="fas fa-lightbulb"></i> Digite pelo menos 3 caracteres para buscar
                    </div>
                    <div id="searchLoading" class="loading-spinner hidden">
                        <div class="spinner"></div>
                        <p style="color: #9ca3af;">Buscando filmes e séries...</p>
                    </div>
                    <div id="searchResults" class="media-grid"></div>
                    <button id="btnLoadMore" class="btn-load-more hidden">
                        <i class="fas fa-arrow-down"></i> Ver Mais Resultados
                    </button>
                    <div id="resultsCounter" class="results-counter hidden"></div>
                    <div id="emptySearch" class="empty-search hidden">
                        <i class="fas fa-film"></i>
                        <h3>Comece a pesquisar</h3>
                        <p>Digite o nome de um filme ou série para encontrar</p>
                    </div>
                </div>
            </div>
            <!-- VISUALIZAÇÃO MINHA LISTA -->
            <div id="myListView">
                <h2>Minha Lista</h2>
                <div id="myListContent"></div>
            </div>
            <!-- NOVA VISUALIZAÇÃO DE FRANQUIA -->
            <div id="franchiseView" class="hidden">
                <h2 id="franchiseTitle"></h2>
                <div class="franchise-controls">
                    <p class="text-secondary m-0" id="franchiseCount"></p>
                    <select id="franchiseSortSelect" onchange="sortAndDisplayFranchiseItems()">
                        <option value="popularity.desc">Relevância (Padrão)</option>
                        <option value="vote_average.desc">Melhor Nota (IMDb/TMDb)</option>
                        <option value="vote_average.asc">Pior Nota (IMDb/TMDb)</option>
                        <option value="release_date.desc">Data (Mais Recente)</option>
                        <option value="release_date.asc">Data (Mais Antiga)</option>
                    </select>
                </div>
                <div id="franchiseLoading" class="franchise-loading">
                    <div class="spinner"></div>
                    <p style="color: #9ca3af;">Carregando todos os títulos da franquia...</p>
                </div>
                <div id="franchiseContent" class="franchise-grid"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal de Detalhes -->
    <div class="modal-overlay" id="modalDetails">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
    
    <script>
        // --- CONFIGURAÇÕES DE API ---
        const firebaseConfig = {
            apiKey: "AIzaSyD57nzPfUhJAFn0haIGANSWTKODgeQ0nLA",
            authDomain: "lastwatch-e2c32.firebaseapp.com",
            projectId: "lastwatch-e2c32",
            storageBucket: "lastwatch-e2c32.firebasestorage.app",
            messagingSenderId: "1060501735643",
            appId: "1:1060501735643:web:793d4cfa7b524dd7c1e4fe"
        };
        const OMDB_API_KEY = 'f860b830';
        // NOVAS CHAVES TMDB
        const TMDB_API_KEY = '952b590dc733b35aa97577fd50304ae0';
        const TMDB_BASE_IMAGE_URL = 'https://image.tmdb.org/t/p/w500'; 
        const TMDB_FALLBACK_POSTER = 'https://placehold.co/120x180/1f2937/9ca3af?text=?';
        
        let franchiseItemsData = []; // Armazena os dados da franquia para filtragem local
        
        // --- INICIALIZAÇÃO FIREBASE ---
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        // --- FUNÇÕES GLOBAIS DE UTILIDADE ---

        function showToast(message, type = 'error') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'error' ? 'fa-exclamation-circle' : 
                         type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        window.performSearchAndOpenModal = async (title) => {
            closeModal();
            showToast(`Buscando detalhes para "${title}"...`, 'info');
            
            try {
                // Ao invés de buscar por título (que pode falhar), usaremos a busca do OMDB
                const response = await fetch(`https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&s=${encodeURIComponent(title)}&page=1`);
                const data = await response.json();
                
                if (data.Response === 'True' && data.Search.length > 0) {
                    const firstMatch = data.Search[0];
                    openDetailsModal(firstMatch.imdbID);
                } else {
                    showToast(`Detalhes não encontrados para "${title}" no OMDB.`, 'error');
                }
            } catch (e) {
                showToast(`Erro ao buscar detalhes de "${title}".`, 'error');
            }
        }


        // --- FUNÇÕES DE AUTENTICAÇÃO E NAVEGAÇÃO ---

        auth.onAuthStateChanged(user => {
            currentUser = user;
            document.getElementById('authContainer').style.display = user ? 'none' : 'flex';
            document.getElementById('appContainer').style.display = user ? 'block' : 'none';
            if(user) loadMyList();
        });

        document.getElementById('btnToggleAuth').addEventListener('click', () => {
            const login = document.getElementById('loginForm');
            const signup = document.getElementById('signupForm');
            const btn = document.getElementById('btnToggleAuth');
            if(login.classList.contains('hidden')) {
                login.classList.remove('hidden');
                signup.classList.add('hidden');
                btn.textContent = 'Criar nova conta';
            } else {
                login.classList.add('hidden');
                signup.classList.remove('hidden');
                btn.textContent = 'Já tenho conta';
            }
        });

        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch(e) {
                document.getElementById('authError').textContent = e.message;
                document.getElementById('authError').classList.remove('hidden');
            }
        });

        document.getElementById('btnSignup').addEventListener('click', async () => {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch(e) {
                document.getElementById('authError').textContent = e.message;
                document.getElementById('authError').classList.remove('hidden');
            }
        });

        document.getElementById('btnLogout').addEventListener('click', () => auth.signOut());

        function showView(viewId) {
            document.getElementById('searchView').classList.add('hidden');
            document.getElementById('myListView').classList.add('hidden');
            document.getElementById('franchiseView').classList.add('hidden');
            document.getElementById('btnMyList').classList.remove('active');
            document.getElementById('btnSearch').classList.remove('active');

            document.getElementById(viewId).classList.remove('hidden');
            if (viewId === 'myListView') {
                document.getElementById('btnMyList').classList.add('active');
                loadMyList();
            } else if (viewId === 'searchView') {
                document.getElementById('btnSearch').classList.add('active');
                document.getElementById('emptySearch').classList.remove('hidden');
                document.getElementById('searchResults').innerHTML = '';
            }
        }

        document.getElementById('btnMyList').addEventListener('click', () => showView('myListView'));
        document.getElementById('btnSearch').addEventListener('click', () => showView('searchView'));

        // --- FUNÇÕES DE PESQUISA OMDB (MANTIDAS) ---

        let searchTimeout;
        let lastQuery = '';
        let currentPage = 1;
        let totalResults = 0;
        let loadedResults = 0;
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            clearTimeout(searchTimeout);
            if (query === '') {
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('emptySearch').classList.remove('hidden');
                document.getElementById('searchLoading').classList.add('hidden');
                document.getElementById('btnLoadMore').classList.add('hidden');
                document.getElementById('resultsCounter').classList.add('hidden');
                document.getElementById('searchInfo').innerHTML = '<i class="fas fa-lightbulb"></i> Digite pelo menos 3 caracteres para buscar';
                return;
            }
            if (query.length < 3) {
                document.getElementById('searchResults').innerHTML = '';
                document.getElementById('emptySearch').classList.add('hidden');
                document.getElementById('searchLoading').classList.add('hidden');
                document.getElementById('btnLoadMore').classList.add('hidden');
                document.getElementById('resultsCounter').classList.add('hidden');
                document.getElementById('searchInfo').innerHTML = `<i class="fas fa-keyboard"></i> Digite mais ${3 - query.length} caractere(s)...`;
                return;
            }
            document.getElementById('searchInfo').innerHTML = '<i class="fas fa-search"></i> Buscando...';
            currentPage = 1;
            totalResults = 0;
            loadedResults = 0;
            searchTimeout = setTimeout(() => {
                performSearch(query, 1, true);
            }, 500);
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                if (query.length >= 3) {
                    currentPage = 1;
                    totalResults = 0;
                    loadedResults = 0;
                    performSearch(query, 1, true);
                } else {
                    showToast('A pesquisa deve ter no mínimo 3 caracteres', 'error');
                }
            }
        });

        document.getElementById('btnLoadMore').addEventListener('click', () => {
            const query = document.getElementById('searchInput').value.trim();
            currentPage++;
            performSearch(query, currentPage, false);
        });

        async function performSearch(query, page = 1, clearResults = true) {
            if (query !== lastQuery) {
                lastQuery = query;
                currentPage = 1;
                page = 1;
                clearResults = true;
            }
            
            const loading = document.getElementById('searchLoading');
            const results = document.getElementById('searchResults');
            const empty = document.getElementById('emptySearch');
            const info = document.getElementById('searchInfo');
            const btnLoadMore = document.getElementById('btnLoadMore');
            const counter = document.getElementById('resultsCounter');
            
            if (clearResults) {
                loading.classList.remove('hidden');
                results.innerHTML = '';
                btnLoadMore.classList.add('hidden');
                counter.classList.add('hidden');
            } else {
                btnLoadMore.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
                btnLoadMore.disabled = true;
            }
            empty.classList.add('hidden');
            
            try {
                const response = await fetch(`https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&s=${encodeURIComponent(query)}&page=${page}`);
                const data = await response.json();
                
                loading.classList.add('hidden');
                btnLoadMore.disabled = false;
                btnLoadMore.innerHTML = '<i class="fas fa-arrow-down"></i> Ver Mais Resultados';
                
                if (data.Response === 'True') {
                    totalResults = parseInt(data.totalResults);
                    if (clearResults) loadedResults = 0;
                    loadedResults += data.Search.length;
                    info.innerHTML = `<i class="fas fa-check-circle"></i> Encontrados ${totalResults} resultado(s)`;
                    displaySearchResults(data.Search, clearResults);
                    
                    if (loadedResults < totalResults) {
                        btnLoadMore.classList.remove('hidden');
                        counter.classList.remove('hidden');
                        counter.innerHTML = `Mostrando <strong>${loadedResults}</strong> de <strong>${totalResults}</strong> resultados`;
                    } else {
                        btnLoadMore.classList.add('hidden');
                        counter.classList.remove('hidden');
                        counter.innerHTML = `✅ Todos os <strong>${totalResults}</strong> resultados foram carregados`;
                    }
                } else {
                    info.innerHTML = '<i class="fas fa-times-circle"></i> Nenhum resultado encontrado';
                    btnLoadMore.classList.add('hidden');
                    counter.classList.add('hidden');
                    if (clearResults) {
                        results.innerHTML = `<div class="empty-search" style="grid-column: 1/-1;"><i class="fas fa-search"></i><h3>Nenhum resultado</h3><p>Não encontramos nada para "${query}"</p><p style="margin-top: 10px; font-size: 0.9rem;">Tente:</p><ul style="list-style: none; padding: 0; color: #9ca3af; font-size: 0.9rem;"><li>• Verificar a ortografia</li><li>• Usar termos mais genéricos</li><li>• Pesquisar em inglês</li></ul></div>`;
                    }
                }
            } catch (error) {
                loading.classList.add('hidden');
                btnLoadMore.disabled = false;
                btnLoadMore.innerHTML = '<i class="fas fa-arrow-down"></i> Ver Mais Resultados';
                info.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro ao buscar';
                showToast('Erro ao buscar: ' + error.message, 'error');
            }
        }

        function displaySearchResults(items, clearResults = true) {
            const results = document.getElementById('searchResults');
            if (clearResults) { results.innerHTML = ''; }
            const startIndex = results.children.length;
            
            items.forEach((media, index) => {
                const card = document.createElement('div');
                card.className = 'media-card fade-in';
                card.style.animationDelay = `${index * 0.05}s`;
                const typeLabel = media.Type === 'movie' ? 'Filme' : media.Type === 'series' ? 'Série' : media.Type;
                const cardId = `card-${media.imdbID}`;
                card.id = cardId;
                
                card.innerHTML = `
                    <img 
                        src="${media.Poster !== 'N/A' ? media.Poster : 'https://via.placeholder.com/300x450/1f2937/9ca3af?text=Sem+Imagem'}" 
                        alt="${media.Title}"
                        onerror="this.src='https://via.placeholder.com/300x450/1f2937/9ca3af?text=Sem+Imagem'"
                    >
                    <div class="media-card-body">
                        <div class="media-card-title" title="${media.Title}">${media.Title}</div>
                        <div class="media-card-meta">
                            <span class="media-card-year">${media.Year}</span>
                            <span class="media-card-type">${typeLabel}</span>
                        </div>
                        <button class="btn-add" data-imdb="${media.imdbID}">
                            <i class="fas fa-plus"></i> Adicionar à Lista
                        </button>
                    </div>
                `;
                results.appendChild(card);
                
                setTimeout(() => {
                    const addedCard = document.getElementById(cardId);
                    if (addedCard) {
                        addedCard.addEventListener('click', function(e) {
                            if (e.target.closest('.btn-add')) {
                                e.stopPropagation();
                                addItemFromSearch(media.imdbID, media.Title, media.Year, media.Poster, media.Type, e);
                            } else {
                                openDetailsModal(media.imdbID);
                            }
                        });
                    }
                }, 50);
            });
            
            if (!clearResults && items.length > 0) {
                setTimeout(() => {
                    const firstNewCard = results.children[startIndex];
                    if (firstNewCard) {
                        firstNewCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
        }

        // --- FUNÇÕES DE LISTA DE ACOMPANHAMENTO (MANTIDAS) ---

        window.addItemFromSearch = async (imdbID, title, year, poster, type, event) => {
            try {
                if (!currentUser) {
                    showToast('Você precisa estar logado para adicionar itens!', 'error');
                    return;
                }
                
                const existing = await db.collection('watchlist')
                    .where('userId', '==', currentUser.uid)
                    .where('imdbID', '==', imdbID)
                    .get();
                
                if (!existing.empty) {
                    showToast('Este item já está na sua lista!', 'error');
                    if (event && event.target.closest('.btn-add-modal')) {
                        event.target.innerHTML = `<i class="fas fa-exclamation-circle"></i> Já Adicionado`;
                        event.target.style.background = '#fbbf24';
                        event.target.disabled = true;
                    }
                    return;
                }
                
                await db.collection('watchlist').add({
                    userId: currentUser.uid,
                    imdbID, title, year, poster, type,
                    currentEpisode: 1, currentSeason: 1, currentTime: 0,
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`"${title}" adicionado à sua lista!`, 'success');
                
                if (event && (event.target.closest('.btn-add') || event.target.closest('.btn-add-modal'))) {
                    event.target.innerHTML = '<i class="fas fa-check"></i> Adicionado!';
                    event.target.style.background = '#10b981';
                    event.target.disabled = true;
                }
                
            } catch(error) {
                showToast('Erro ao adicionar: ' + error.message, 'error');
            }
        };

        async function loadMyList() {
            const snapshot = await db.collection('watchlist').where('userId','==',currentUser.uid).get();
            const content = document.getElementById('myListContent');
            content.innerHTML = '';
            if(snapshot.empty) {
                content.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px 0;">Sua lista está vazia. Vá para "Pesquisar" para adicionar filmes e séries.</p>';
                return;
            }
            snapshot.forEach(doc => {
                const d = doc.data();
                content.innerHTML += `
                    <div class="list-item" onclick="openDetailsModal('${d.imdbID}')" style="cursor:pointer;">
                        <img src="${d.poster !== 'N/A' ? d.poster : 'https://via.placeholder.com/120x180/1f2937/9ca3af?text=Sem+Imagem'}" onerror="this.src='https://via.placeholder.com/120x180/1f2937/9ca3af?text=Sem+Imagem'">
                        <div>
                            <h4>${d.title}</h4>
                            <p>${d.year} • ${d.type}</p>
                            ${d.type === 'series' ? `
                                <label>Temp: <input type="number" value="${d.currentSeason}" onchange="update('${doc.id}','currentSeason',this.value)" onclick="event.stopPropagation();"></label>
                                <label>Ep: <input type="number" value="${d.currentEpisode}" onchange="update('${doc.id}','currentEpisode',this.value)" onclick="event.stopPropagation();"></label>
                            ` : `
                                <label>Min: <input type="number" value="${d.currentTime}" onchange="update('${doc.id}','currentTime',this.value)" onclick="event.stopPropagation();"></label>
                            `}
                            <button class="btn-remove mt-2" onclick="event.stopPropagation(); remove('${doc.id}')">Remover</button>
                        </div>
                    </div>
                `;
            });
        }

        window.update = (id, field, value) => {
            db.collection('watchlist').doc(id).update({[field]: parseInt(value) || 0}); 
        };

        window.remove = async (id) => {
            if(true) { // Substituindo confirm()
                try {
                    await db.collection('watchlist').doc(id).delete();
                    showToast('Item removido com sucesso!', 'success');
                    loadMyList();
                } catch(e) {
                    showToast('Erro ao remover: ' + e.message, 'error');
                }
            }
        };

        // --- FUNÇÕES TMDB E FRANQUIA ---

        async function fetchTmdbCollection(collectionId) {
            const url = `https://api.themoviedb.org/3/collection/${collectionId}?api_key=${TMDB_API_KEY}&language=pt-BR`;
            const response = await fetch(url);
            if (!response.ok) throw new Error("Falha ao buscar detalhes da coleção TMDB.");
            const data = await response.json();
            return data;
        }

        window.openFranchiseView = async (collectionId, collectionName) => {
            showView('franchiseView');
            document.getElementById('franchiseTitle').textContent = `Franquia: ${collectionName}`;
            document.getElementById('franchiseContent').innerHTML = '';
            document.getElementById('franchiseLoading').classList.remove('hidden');
            document.getElementById('franchiseCount').textContent = 'Carregando...';
            
            try {
                const collectionData = await fetchTmdbCollection(collectionId);
                
                franchiseItemsData = collectionData.parts
                    .filter(item => item.poster_path && (item.title || item.name))
                    .sort((a, b) => a.release_date < b.release_date ? -1 : 1);
                
                document.getElementById('franchiseLoading').classList.add('hidden');
                document.getElementById('franchiseSortSelect').value = 'popularity.desc';
                
                sortAndDisplayFranchiseItems();
                
            } catch (error) {
                console.error("Erro ao carregar a franquia:", error);
                document.getElementById('franchiseLoading').innerHTML = `<p class="text-danger">Erro ao carregar a franquia. ${error.message}</p>`;
            }
        };
        
        window.sortAndDisplayFranchiseItems = () => {
            const sortBy = document.getElementById('franchiseSortSelect').value;
            const content = document.getElementById('franchiseContent');
            
            let sortedData = [...franchiseItemsData];
            
            sortedData.sort((a, b) => {
                const valA = parseFloat(a[sortBy.split('.')[0]] || 0);
                const valB = parseFloat(b[sortBy.split('.')[0]] || 0);
                
                if (sortBy.includes('date')) {
                    const dateA = new Date(a.release_date || '1900-01-01').getTime();
                    const dateB = new Date(b.release_date || '1900-01-01').getTime();
                    return sortBy.endsWith('.desc') ? dateB - dateA : dateA - dateB;
                } else {
                    return sortBy.endsWith('.desc') ? valB - valA : valA - valB;
                }
            });

            document.getElementById('franchiseCount').textContent = `${sortedData.length} título(s) encontrado(s)`;
            content.innerHTML = sortedData.map(item => {
                const title = item.title || item.name;
                const year = item.release_date ? item.release_date.substring(0, 4) : 'S/D';
                const poster = TMDB_BASE_IMAGE_URL + item.poster_path;
                const vote = (item.vote_average || 0).toFixed(1);

                return `
                    <div class="franchise-card" onclick="performSearchAndOpenModal('${title.replace(/'/g, "\\'")}')">
                        <img src="${poster}" alt="${title}" onerror="this.src='${TMDB_FALLBACK_POSTER}'">
                        <div class="franchise-card-info">
                            <div class="franchise-card-title" title="${title}">${title}</div>
                            <div class="franchise-card-meta">
                                ${year} • <i class="fas fa-star" style="color:#fbbf24; margin-right: 3px;"></i> ${vote}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };


        // --- FUNÇÕES DO MODAL DE DETALHES (CORRIGIDO) ---
        
        window.closeModal = () => {
            document.getElementById('modalDetails').classList.remove('active');
            setTimeout(() => {
                document.getElementById('modalBody').innerHTML = ''; 
            }, 300);
        }

        window.openDetailsModal = async (imdbID) => {
            const modal = document.getElementById('modalDetails');
            const modalBody = document.getElementById('modalBody');
            
            modal.classList.add('active');
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="spinner"></div>
                    <p style="color: #9ca3af;">Carregando informações completas...</p>
                </div>
            `;
            
            let omdbData;
            let similarTitles = [];
            let tmdbDetails = null; 
            let franchiseHtml = ''; 

            try {
                // 1. Busca OMDB
                const omdbResponse = await fetch(`https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&i=${imdbID}&plot=full`);
                omdbData = await omdbResponse.json();
                
                if (omdbData.Response === 'False') {
                    modalBody.innerHTML = `<p class="text-danger p-5 text-center">Erro: ${omdbData.Error || 'Detalhes não encontrados.'}</p>`;
                    return;
                }
                
                const omdbType = omdbData.Type === 'series' ? 'tv' : 'movie';
                const findUrl = `https://api.themoviedb.org/3/find/${imdbID}?external_source=imdb_id&api_key=${TMDB_API_KEY}`;
                let tmdbId = null;

                try {
                    // 2a. Buscar ID do TMDb
                    const tmdbFindResponse = await fetch(findUrl);
                    const tmdbFindData = await tmdbFindResponse.json();

                    if (omdbType === 'movie' && tmdbFindData.movie_results && tmdbFindData.movie_results.length > 0) {
                        tmdbId = tmdbFindData.movie_results[0].id;
                    } else if (omdbType === 'tv' && tmdbFindData.tv_results && tmdbFindData.tv_results.length > 0) {
                        tmdbId = tmdbFindData.tv_results[0].id;
                    }

                    if (tmdbId) {
                        // 2b. Buscar detalhes TMDb (PT-BR)
                        const detailsUrl = `https://api.themoviedb.org/3/${omdbType}/${tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR`;
                        const detailsResponse = await fetch(detailsUrl);
                        tmdbDetails = await detailsResponse.json();
                        
                        // NOVO: Busca Franquia/Coleção (Apenas para Filmes)
                        if (omdbType === 'movie' && tmdbDetails.belongs_to_collection) {
                            const collectionId = tmdbDetails.belongs_to_collection.id;
                            const collectionName = tmdbDetails.belongs_to_collection.name;
                            
                            const collectionData = await fetchTmdbCollection(collectionId);
                            
                            // Filtra para pegar 5 sugestões (excluindo o atual, se presente)
                            const franchiseSuggestions = collectionData.parts
                                .filter(p => p.id !== tmdbId && p.poster_path && (p.title || p.name))
                                .slice(0, 5);

                            if (franchiseSuggestions.length > 0) {
                                const franchiseItemsHtml = franchiseSuggestions.map(t => {
                                    const posterSrc = TMDB_BASE_IMAGE_URL + t.poster_path;
                                    const mediaTitle = t.title || t.name;
                                    
                                    return `
                                        <div class="similar-item" onclick="performSearchAndOpenModal('${mediaTitle}')">
                                            <img src="${posterSrc}" alt="${mediaTitle} Poster" onerror="this.src='${TMDB_FALLBACK_POSTER}'">
                                            <div class="similar-item-title" title="${mediaTitle}">${mediaTitle}</div>
                                        </div>
                                    `;
                                }).join('');

                                franchiseHtml = `
                                    <div class="franchise-header">
                                        <h3 class="section-title" style="margin: 30px 0 0 0;"><i class="fas fa-layer-group"></i> Mais de ${collectionName}</h3>
                                        <!-- Texto do botão alterado: Mais filmes de [Franquia] -->
                                        <button class="btn-franchise-details" onclick="openFranchiseView(${collectionId}, '${collectionName.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-list"></i> Mais filmes de ${collectionName}
                                        </button>
                                    </div>
                                    <div class="similar-grid" style="margin-bottom: 30px;">
                                        ${franchiseItemsHtml}
                                    </div>
                                `;
                            }
                        }

                        // 2c. Buscar títulos RECOMENDADOS (Melhor que Similar)
                        const recommendationsUrl = `https://api.themoviedb.org/3/${omdbType}/${tmdbId}/recommendations?api_key=${TMDB_API_KEY}&language=pt-BR`;
                        const recommendationsResponse = await fetch(recommendationsUrl);
                        const recommendationsData = await recommendationsResponse.json();

                        if (recommendationsData.results && recommendationsData.results.length > 0) {
                            // Usamos recommendationsData.results para a seção "Parecidos com"
                            similarTitles = recommendationsData.results.filter(item => item.poster_path).slice(0, 5);
                        }
                    }
                } catch (e) {
                    console.error("Erro na busca por TMDb, detalhes ou similares:", e);
                }

                // 3. Definir a Sinopse
                const sinopseText = (tmdbDetails && tmdbDetails.overview && tmdbDetails.overview.trim().length > 0) ? 
                                    tmdbDetails.overview : 
                                    (omdbData.Plot !== 'N/A' ? omdbData.Plot : 'Sinopse não disponível.');
                
                
                // 4. Gerar HTML
                const typeLabel = omdbData.Type === 'movie' ? 'Filme' : omdbData.Type === 'series' ? 'Série' : omdbData.Type;
                const rating = omdbData.imdbRating !== 'N/A' ? `${omdbData.imdbRating}/10` : 'S/I';
                const yearText = omdbData.Type === 'series' && omdbData.Year.includes('–') ? omdbData.Year : omdbData.Year;
                const safeTitle = omdbData.Title.replace(/'/g, "\\'"); 
                const posterUrl = omdbData.Poster !== 'N/A' ? omdbData.Poster : 'https://via.placeholder.com/150x225/1f2937/9ca3af?text=Sem+Imagem';
                const hasRatings = omdbData.Ratings && omdbData.Ratings.length > 0;
                
                
                // 5. Montar o HTML dos Similares
                let similarHtml = '';
                if (similarTitles.length > 0) {
                    const similarItemsHtml = similarTitles.map(t => {
                        const posterSrc = TMDB_BASE_IMAGE_URL + t.poster_path;
                        const mediaTitle = t.title || t.name; 
                        
                        return `
                            <div class="similar-item" onclick="performSearchAndOpenModal('${mediaTitle.replace(/'/g, "\\'")}')">
                                <img src="${posterSrc}" alt="${mediaTitle} Poster" onerror="this.src='${TMDB_FALLBACK_POSTER}'">
                                <div class="similar-item-title" title="${mediaTitle}">${mediaTitle}</div>
                            </div>
                        `;
                    }).join('');

                    similarHtml = `
                        <h3 class="section-title"><i class="fas fa-clone"></i> Parecidos com ${omdbData.Title}</h3>
                        <div class="similar-grid">
                            ${similarItemsHtml}
                        </div>
                    `;
                }

                modalBody.innerHTML = `
                    <div class="modal-body">
                        
                        <!-- 1. SEÇÃO PRINCIPAL -->
                        <div class="modal-top-section">
                            <img 
                                src="${posterUrl}" 
                                alt="${omdbData.Title}" 
                                class="modal-top-poster"
                                onerror="this.src='https://via.placeholder.com/180x270/1f2937/9ca3af?text=Sem+Imagem'"
                            >
                            <div class="modal-top-info">
                                <h2 class="modal-top-title">${omdbData.Title} (${yearText})</h2>
                                
                                <!-- Botão em Evidência -->
                                <button class="btn-add-modal mb-3" onclick="addItemFromSearch('${omdbData.imdbID}', '${safeTitle}', '${omdbData.Year}', '${omdbData.Poster}', '${omdbData.Type}', event)">
                                    <i class="fas fa-plus-circle"></i> Adicionar à Minha Lista
                                </button>

                                <div class="modal-meta" style="justify-content: flex-start;">
                                    <span class="modal-badge">${typeLabel}</span>
                                    <div class="modal-rating">
                                        <i class="fas fa-star"></i> ${rating}
                                    </div>
                                    <span class="text-secondary">${omdbData.Runtime !== 'N/A' ? omdbData.Runtime : omdbData.totalSeasons ? omdbData.totalSeasons + ' Temporadas' : ''}</span>
                                </div>
                                <p class="text-secondary mt-2">${omdbData.Genre}</p>
                            </div>
                        </div>

                        <!-- 2. SINOPSE (EVIDÊNCIA) -->
                        <div class="modal-synopsis-box">
                            <h4>Sinopse</h4>
                            <p class="synopsis">${sinopseText}</p>
                        </div>
                        
                        <!-- 3. DETALHES TÉCNICOS -->
                        <h3 class="section-title"><i class="fas fa-info-circle"></i> Detalhes Técnicos</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Diretor</div>
                                <div class="info-value">${omdbData.Director !== 'N/A' ? omdbData.Director : 'S/I'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Escritores</div>
                                <div class="info-value">${omdbData.Writer !== 'N/A' ? omdbData.Writer : 'S/I'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Atores Principais</div>
                                <div class="info-value">${omdbData.Actors !== 'N/A' ? omdbData.Actors : 'S/I'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">País / Idioma</div>
                                <div class="info-value">${omdbData.Country !== 'N/A' ? omdbData.Country : 'S/I'} / ${omdbData.Language !== 'N/A' ? omdbData.Language : 'S/I'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Classificação Indicativa</div>
                                <div class="info-value">${omdbData.Rated !== 'N/A' ? omdbData.Rated : 'S/I'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Data de Lançamento</div>
                                <div class="info-value">${omdbData.Released !== 'N/A' ? omdbData.Released : 'S/I'}</div>
                            </div>
                        </div>

                        <!-- 4. AVALIAÇÕES (Opcional) -->
                        ${hasRatings ? `
                            <h3 class="section-title"><i class="fas fa-poll"></i> Avaliações</h3>
                            <div class="info-grid">
                                ${omdbData.Ratings.map(r => `
                                    <div class="info-item">
                                        <div class="info-label">${r.Source}</div>
                                        <div class="info-value">${r.Value}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- 5. MAIS DA FRANQUIA (ACIMA DOS PARECIDOS) -->
                        ${franchiseHtml}
                        
                        <!-- 6. TÍTULOS PARECIDOS (Ao fim) -->
                        ${similarHtml}
                    </div>
                `;

            } catch (error) {
                console.error('Erro fatal ao carregar o modal de detalhes:', error);
                modalBody.innerHTML = `<p class="text-danger p-5 text-center">❌ Não foi possível carregar os detalhes completos. Tente novamente mais tarde.</p>`;
                showToast('Erro ao carregar detalhes: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
